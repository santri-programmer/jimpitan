<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Input Harian Data Jimpitan - Offline</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="JimpitanApp" />

    <!-- Performance Optimizations -->
    <link rel="preload" href="./style.css" as="style" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />

    <!-- Manifest & Icons -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/192.png" />

    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Stylesheets -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css" />

    <!-- Critical Inline CSS -->
    <style>
      .critical-hidden {
        opacity: 0;
        transform: translateY(-10px);
      }
      .critical-show {
        opacity: 1 !important;
        transform: none !important;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .hardware-accelerated {
        transform: translateZ(0);
        backface-visibility: hidden;
      }
      /* Optimized scroll for mobile */
      .optimized-scroll {
        -webkit-overflow-scrolling: touch;
      }
      /* Touch optimization */
      .touch-optimized {
        touch-action: manipulation;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <header class="text-center mb-8">
        <h1
          class="text-3xl md:text-4xl font-bold text-purple-700 mb-2 critical-show"
        >
          <i class="fas fa-journal-whills mr-3"></i>Sistem Input Harian
        </h1>
        <div
          class="inline-block bg-white px-4 py-2 rounded-lg shadow-sm text-gray-700 mb-4 critical-show"
        >
          <i class="fas fa-calendar-day mr-2 text-purple-500"></i>
          <span id="tanggalHariIni"></span>
        </div>
        <p class="text-gray-600 text-sm critical-show">
          Aplikasi Pencatatan Data Jimpitan - Mode Offline
        </p>
      </header>

      <div
        id="notifikasi"
        class="mb-4 md:mb-6 text-center p-3 md:p-4 rounded-xl transition-all duration-300 critical-hidden"
      ></div>

      <!-- Input Section -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hardware-accelerated">
        <h2
          class="text-xl font-semibold text-gray-800 mb-4 flex items-center critical-show"
        >
          <i class="fas fa-plus-circle mr-2 text-purple-500"></i>Tambah Nominal
        </h2>

        <div class="mb-4">
          <label
            for="kategoriDonatur"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Pilih Kategori RT</label
          >
          <select
            id="kategoriDonatur"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 touch-optimized"
          >
            <option value="kategori1" selected>RT Tengah</option>
            <option value="kategori2">RT Kulon</option>
            <option value="kategori3">RT Kidul</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label
              for="donatur"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Nama</label
            >
            <select
              id="donatur"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 touch-optimized"
            >
              <option value="">Pilih Donatur</option>
            </select>
          </div>
          <div>
            <label
              for="pemasukan"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Nominal Input</label
            >
            <input
              type="number"
              id="pemasukan"
              placeholder="Masukkan nominal"
              min="0"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 touch-optimized"
            />
          </div>
          <div class="flex items-end">
            <button
              id="btnTambah"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 touch-optimized"
            >
              <span id="btnText">Tambah</span>
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-4">
          <button
            class="quick-amount bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition duration-200 touch-optimized"
            data-amount="0"
          >
            Rp 0
          </button>
          <button
            class="quick-amount bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition duration-200 touch-optimized"
            data-amount="1000"
          >
            Rp 1,000
          </button>
          <button
            class="quick-amount bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition duration-200 touch-optimized"
            data-amount="2000"
          >
            Rp 2,000
          </button>
          <button
            class="quick-amount bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition duration-200 touch-optimized"
            data-amount="5000"
          >
            Rp 5,000
          </button>
        </div>
      </div>

      <!-- Data Table Section -->
      <div
        class="bg-white rounded-xl shadow-md p-6 mb-6 overflow-x-auto hardware-accelerated optimized-scroll"
      >
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between mb-4"
        >
          <h2
            class="text-xl font-semibold text-gray-800 flex items-center critical-show"
          >
            <i class="fas fa-list-alt mr-2 text-purple-500"></i>Daftar Input
            Hari Ini
          </h2>
          <div class="flex items-center gap-2 mt-2 md:mt-0">
            <span
              id="dataCount"
              class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm critical-show"
              >0 data</span
            >
            <button
              id="btnRefresh"
              class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition duration-200 touch-optimized"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <table id="tabelDonasi" class="w-full text-left">
          <thead>
            <tr class="bg-gray-100 text-gray-700">
              <th class="py-3 px-4 md:px-6 rounded-tl-lg">Nama</th>
              <th class="py-3 px-4 md:px-6 text-right">Nominal</th>
              <th class="py-3 px-4 md:px-6 text-center rounded-tr-lg">Aksi</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data akan diisi via JavaScript -->
          </tbody>
          <tfoot>
            <tr class="bg-gray-50 border-t border-gray-200">
              <td class="py-3 px-4 md:px-6 font-semibold">Total</td>
              <td
                id="totalDonasi"
                class="py-3 px-4 md:px-6 text-right font-mono font-semibold text-purple-700"
              >
                Rp 0
              </td>
              <td class="py-3 px-4 md:px-6"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Management Section -->
      <div class="bg-white rounded-xl shadow-md p-6 hardware-accelerated">
        <h2
          class="text-xl font-semibold text-gray-800 mb-4 flex items-center critical-show"
        >
          <i class="fas fa-database mr-2 text-purple-500"></i>Manajemen Data
        </h2>

        <div
          id="dataStatus"
          class="mb-4 text-center p-4 rounded-xl bg-blue-50 border border-blue-200 text-blue-700 critical-show"
        >
          <i class="fas fa-info-circle mr-2"></i>
          <span id="dataInfo"
            >Semua data disimpan secara lokal di perangkat Anda</span
          >
        </div>

        <div class="flex justify-center gap-4 flex-wrap">
          <button
            id="btnExport"
            class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 min-w-[140px] max-w-[280px] touch-optimized"
          >
            <i class="fas fa-download"></i> Export Data
          </button>
          <button
            id="btnHapus"
            class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 min-w-[140px] max-w-[280px] touch-optimized"
          >
            <i class="fas fa-trash-alt"></i>Hapus Data
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript Files -->
    <script src="db.js"></script>
    <script src="script.js"></script>

    <!-- Initialization Script -->
    <script>
      // Performance optimized initialization
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ Initializing Jimpitan App...");

        // Set today's date
        const tanggalHariIni = new Date().toLocaleDateString("id-ID", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        document.getElementById("tanggalHariIni").textContent = tanggalHariIni;

        // Event delegation untuk quick amount buttons
        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("quick-amount")) {
            const amount = e.target.getAttribute("data-amount");
            const pemasukanInput = document.getElementById("pemasukan");
            if (pemasukanInput) {
              pemasukanInput.value = amount;
              // Tidak ada pemasukanInput.focus() di sini untuk mobile
            }
          }
        });

        // Refresh button
        const btnRefresh = document.getElementById("btnRefresh");
        if (btnRefresh) {
          btnRefresh.addEventListener("click", function () {
            console.log("üîÑ Refreshing application...");
            window.location.reload();
          });
        }

        // Nonaktifkan fokus otomatis pada input nominal di mobile
        const disableMobileFocus = () => {
          const pemasukanInput = document.getElementById("pemasukan");
          if (!pemasukanInput) return;

          // Deteksi perangkat mobile
          const isMobile =
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
              navigator.userAgent
            );

          if (isMobile) {
            // Tambahkan atribut readonly untuk mencegah keyboard muncul otomatis
            pemasukanInput.setAttribute("readonly", "readonly");

            // Hapus readonly ketika user menyentuh input (agar bisa input manual)
            pemasukanInput.addEventListener("touchstart", function () {
              pemasukanInput.removeAttribute("readonly");
              // Fokus manual setelah user menyentuh
              setTimeout(() => {
                pemasukanInput.focus();
              }, 100);
            });

            // Kembalikan ke readonly setelah selesai input
            pemasukanInput.addEventListener("blur", function () {
              setTimeout(() => {
                pemasukanInput.setAttribute("readonly", "readonly");
              }, 500);
            });

            console.log("üì± Mobile mode: Input focus behavior adjusted");
          }
        };

        // Panggil fungsi disable mobile focus
        setTimeout(disableMobileFocus, 500);

        // Show critical elements dengan animation
        setTimeout(() => {
          const hiddenElements = document.querySelectorAll(".critical-hidden");
          hiddenElements.forEach((el) => {
            el.classList.remove("critical-hidden");
            el.classList.add("critical-show");
          });
        }, 100);

        console.log("‚úÖ App initialization completed");
      });

      // Service Worker Registration dengan error handling
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          console.log("üîß Registering Service Worker...");
          navigator.serviceWorker
            .register("./sw.js")
            .then(function (registration) {
              console.log(
                "‚úÖ Service Worker registered with scope:",
                registration.scope
              );

              // Check for updates
              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                console.log("üîÑ New Service Worker found:", newWorker);

                newWorker.addEventListener("statechange", () => {
                  if (
                    newWorker.state === "installed" &&
                    navigator.serviceWorker.controller
                  ) {
                    console.log("üîÑ New content available; please refresh.");
                    // Bisa tambahkan notifikasi ke user di sini
                  }
                });
              });
            })
            .catch(function (error) {
              console.log("‚ùå Service Worker registration failed:", error);
            });
        });
      } else {
        console.log("‚ùå Service Worker not supported");
      }

      // Online/Offline detection
      window.addEventListener("online", function () {
        const indicator = document.getElementById("offlineIndicator");
        if (indicator) {
          indicator.innerHTML =
            '<i class="fas fa-wifi text-green-500"></i> Online';
          indicator.className =
            "fixed top-4 right-4 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm flex items-center gap-2 z-50 critical-show";
        }
      });

      window.addEventListener("offline", function () {
        const indicator = document.getElementById("offlineIndicator");
        if (indicator) {
          indicator.innerHTML =
            '<i class="fas fa-wifi-slash text-red-500"></i> Offline';
          indicator.className =
            "fixed top-4 right-4 bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm flex items-center gap-2 z-50 critical-show";
        }
      });

      // PWA Install Prompt (optional)
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        console.log("üì± PWA install prompt available");

        // Bisa tambahkan button install custom di sini
        // showInstallPromotion();
      });

      window.addEventListener("appinstalled", () => {
        console.log("üéâ PWA installed successfully");
        deferredPrompt = null;
      });

      // MODIFIKASI: Fungsi hapusRow yang diperbaiki agar donatur kembali ke dropdown
      async function hapusRow(kategori, donatur, id) {
        if (!confirm(`Hapus data ${donatur}?`)) return;
        try {
          await db.deleteDailyInput(id);
          dataCache[kategori].delete(donatur);
          dataDonasi = Array.from(dataCache[kategori].values());
          donaturTerinput[kategori].delete(donatur); // ‚≠ê BARIS PENTING: hapus dari Set
          renderTabelTerurut(kategori);
          updateTotalDisplay();
          updateDataCount();
          await muatDropdown(kategori);
          showNotification(`üóëÔ∏è Data ${donatur} dihapus`, true);
        } catch (error) {
          console.error("‚ùå hapusRow error:", error);
          showNotification("Gagal menghapus data", false);
        }
      }

      // Performance monitoring (optional debug features)
      if (
        typeof window !== "undefined" &&
        window.location.search.includes("debug=true")
      ) {
        window.appDebug = {
          version: "2.0.0",
          performance: {
            getLoadTime: () =>
              performance.timing.loadEventEnd -
              performance.timing.navigationStart,
            getMemory: () =>
              performance.memory
                ? {
                    used: Math.round(
                      performance.memory.usedJSHeapSize / 1048576
                    ),
                    total: Math.round(
                      performance.memory.totalJSHeapSize / 1048576
                    ),
                    limit: Math.round(
                      performance.memory.jsHeapSizeLimit / 1048576
                    ),
                  }
                : "Not available",
          },
        };
        console.log("üîß Debug mode enabled", window.appDebug);
      }
    </script>

    <!-- No Script Fallback -->
    <noscript>
      <div
        style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: white;
          z-index: 9999;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          padding: 20px;
          text-align: center;
        "
      >
        <h1 style="color: #dc2626; font-size: 24px; margin-bottom: 20px">
          <i class="fas fa-exclamation-triangle"></i> JavaScript Diperlukan
        </h1>
        <p style="color: #4b5563; font-size: 16px; margin-bottom: 20px">
          Aplikasi Jimpitan membutuhkan JavaScript untuk berfungsi dengan baik.
        </p>
        <p style="color: #6b7280; font-size: 14px">
          Silakan aktifkan JavaScript di browser Anda dan refresh halaman.
        </p>
      </div>
    </noscript>
  </body>
</html>
